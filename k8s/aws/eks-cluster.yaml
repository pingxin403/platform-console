apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig

metadata:
  name: backstage-cluster
  region: us-west-2
  version: '1.28'

# Enhanced VPC configuration with security
vpc:
  enableDnsHostnames: true
  enableDnsSupport: true
  cidr: '10.0.0.0/16'
  nat:
    gateway: HighlyAvailable
  clusterEndpoints:
    privateAccess: true
    publicAccess: true
    publicAccessCIDRs: ['0.0.0.0/0']

# IAM configuration with service accounts
iam:
  withOIDC: true
  serviceAccounts:
    - metadata:
        name: aws-load-balancer-controller
        namespace: kube-system
      wellKnownPolicies:
        awsLoadBalancerController: true
    - metadata:
        name: backstage
        namespace: backstage
      attachPolicyARNs:
        - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
      roleName: backstage-service-account-role

# Managed node groups with security hardening
managedNodeGroups:
  - name: backstage-nodes
    instanceType: t3.medium
    minSize: 2
    maxSize: 6
    desiredCapacity: 3
    volumeSize: 50
    volumeType: gp3
    volumeEncrypted: true

    # Security configuration
    securityGroups:
      withShared: true
      withLocal: true

    # Instance metadata service configuration
    instanceMetadataOptions:
      httpTokens: required
      httpPutResponseHopLimit: 2

    # SSH access (disabled for security)
    ssh:
      allow: false

    # Labels and taints
    labels:
      role: backstage-worker
      environment: production

    tags:
      Environment: production
      Application: backstage
      ManagedBy: eksctl

    # IAM configuration
    iam:
      attachPolicyARNs:
        - arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
        - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
        - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
      withAddonPolicies:
        imageBuilder: true
        autoScaler: true
        certManager: true
        efs: true
        ebs: true
        fsx: true
        cloudWatch: true

# Add-ons with latest versions and enhanced configuration
addons:
  - name: vpc-cni
    version: latest
    configurationValues: |-
      enableNetworkPolicy: "true"
  - name: coredns
    version: latest
  - name: kube-proxy
    version: latest
  - name: aws-ebs-csi-driver
    version: latest
    wellKnownPolicies:
      ebsCSIController: true

# CloudWatch logging with retention
cloudWatch:
  clusterLogging:
    enableTypes: ['*']
    logRetentionInDays: 30

# Security enhancements
secretsEncryption:
  # Uncomment and provide KMS key ARN for secrets encryption
  # keyARN: ${KMS_KEY_ARN}

# Fargate profiles for system workloads (optional)
fargateProfiles:
  - name: fp-system
    selectors:
      - namespace: kube-system
        labels:
          k8s-app: aws-load-balancer-controller
      - namespace: cert-manager
  - name: fp-backstage
    selectors:
      - namespace: backstage
        labels:
          app.kubernetes.io/name: backstage
