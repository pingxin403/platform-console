# Production configuration for Internal Developer Platform
# This file contains production-specific overrides for app-config.yaml

app:
  # Production URL - should match your domain
  baseUrl: https://backstage.${DOMAIN_NAME}

backend:
  # Production backend URL
  baseUrl: https://backstage.${DOMAIN_NAME}
  # Listen on all interfaces in production
  listen: ':7007'
  
  # Enhanced security headers for production
  csp:
    connect-src: ["'self'", 'https:', 'wss:']
    img-src: ["'self'", 'data:', 'https:']
    script-src: ["'self'", "'unsafe-inline'", "'unsafe-eval'"]
    style-src: ["'self'", "'unsafe-inline'", 'https:']
  
  cors:
    origin: https://backstage.${DOMAIN_NAME}
    methods: [GET, HEAD, PATCH, POST, PUT, DELETE]
    credentials: true

  # Production database configuration with SSL
  database:
    client: pg
    connection:
      host: ${POSTGRES_HOST}
      port: ${POSTGRES_PORT}
      user: ${POSTGRES_USER}
      password: ${POSTGRES_PASSWORD}
      database: ${POSTGRES_DB}
      ssl: 
        require: true
        rejectUnauthorized: false
    # Production connection pool settings
    pool:
      min: 5
      max: 20
      acquireTimeoutMillis: 60000
      createTimeoutMillis: 30000
      destroyTimeoutMillis: 5000
      idleTimeoutMillis: 30000
      reapIntervalMillis: 1000
      createRetryIntervalMillis: 200

  # Production logging configuration
  logging:
    level: info
    format: json
    redactSecrets: true

auth:
  providers:
    # Production GitHub OAuth provider
    github:
      production:
        clientId: ${AUTH_GITHUB_CLIENT_ID}
        clientSecret: ${AUTH_GITHUB_CLIENT_SECRET}
        # Production callback URL
        callbackUrl: https://backstage.${DOMAIN_NAME}/api/auth/github/handler/frame
    # Disable guest auth in production
    # guest: {}

# Production TechDocs configuration with S3
techdocs:
  builder: 'external' # Use external builder for production
  generator:
    runIn: 'docker'
  publisher:
    type: 'awsS3'
    awsS3:
      bucketName: ${TECHDOCS_S3_BUCKET_NAME}
      region: ${AWS_REGION}
      # Use IAM roles instead of access keys in production
      credentials:
        roleArn: ${TECHDOCS_S3_ROLE_ARN}

# Production catalog configuration
catalog:
  # Remove example data in production
  locations: []
  
  # Production catalog processing settings
  processing:
    cache:
      ttl: 600 # 10 minutes cache for production
    stitching:
      strategy: deferred
  
  providers:
    github:
      organization:
        organization: ${GITHUB_ORG}
        catalogPath: '/catalog-info.yaml'
        filters:
          branch: 'main'
          repository: '.*'
        schedule:
          frequency: { minutes: 15 } # More frequent updates in production
          timeout: { minutes: 5 }
          initialDelay: { seconds: 30 }

# Production integrations
integrations:
  github:
    - host: github.com
      token: ${GITHUB_TOKEN}
      # Enhanced GitHub integration settings
      apiBaseUrl: https://api.github.com
      rawBaseUrl: https://raw.githubusercontent.com

# Production Kubernetes configuration
kubernetes:
  serviceLocatorMethod:
    type: 'multiTenant'
  clusterLocatorMethods:
    - type: 'config'
      clusters:
        - url: ${KUBERNETES_API_URL}
          name: production
          authProvider: 'aws'
          skipTLSVerify: false
          skipMetricsLookup: false

# Production permission configuration
permission:
  enabled: true
  # TODO: Replace with proper RBAC policy in production
  # policy: 'allow-all' # This should be replaced with a proper policy

# Production proxy configuration for external services
proxy:
  endpoints:
    '/argocd/api':
      target: ${ARGOCD_API_URL}
      changeOrigin: true
      headers:
        Authorization: Bearer ${ARGOCD_TOKEN}
    '/datadog/api':
      target: https://api.datadoghq.com
      changeOrigin: true
      headers:
        DD-API-KEY: ${DATADOG_API_KEY}
        DD-APPLICATION-KEY: ${DATADOG_APP_KEY}